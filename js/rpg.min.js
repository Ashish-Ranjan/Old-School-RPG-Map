/* ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is Old School RPG Map.
 *
 * The Initial Developer of the Original Code is Jono Xia.
 * Portions created by the Initial Developer are Copyright (C) 2007
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *   Jono Xia <jono@mozilla.com>
 *   Gaurav Munjal <Gaurav0@aol.com>
 *   Jebb Burditt <jebb.burditt@gmail.com>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** */
 function cB(){if(cf){var a=window.innerWidth,b=window.innerHeight,c=a/bR.width,d=b/bR.height,e=c>d?d:c,f=0,g=0;c<d?f=(b-bR.height)/2:g=(a-bR.width)/2;for(var h=0;h<ch.length;++h){var i=ch[h];c<d?(i.style.MozTransformOrigin="center left",i.style.WebkitTransformOrigin="center left",i.style.OTransformOrigin="center left",i.style.msTransformOrigin="center left"):(i.style.MozTransformOrigin="top center",i.style.WebkitTransformOrigin="top center",i.style.OTransformOrigin="top center",i.style.msTransformOrigin="top center"),i.style.left=Math.floor(g)+"px",i.style.top=Math.floor(f)+"px",i.style.MozTransform="scale("+e+")",i.style.WebkitTransform="scale("+e+")",i.style.OTransform="scale("+e+")",i.style.msTransform="scale("+e+")",i.style.zIndex=1}}else for(var h=0;h<ch.length;++h){var i=ch[h];i.style.MozTransform="",i.style.WebkitTransform="",i.style.OTransform="",i.style.msTransform="",i.style.left="10px",i.style.top="120px",i.style.zIndex=0}}function cA(){if(cv&&!ce&&!b_.isAnimating()){var a=cv;cv=0;switch(a){case co:b$.move(0,1,l);break;case cp:b$.move(0,-1,i);break;case cr:b$.move(1,0,j);break;case cq:b$.move(-1,0,m);break;case cs:case ct:cb.textDisplayed()?cb.clearText():b_.doAction()}}}function cz(a,b){if(cg.isLoadComplete())if(b_.isAnimating())cv=a,b.preventDefault();else{console.log(a);switch(a){case co:console.log("down arrow"),cc.isDisplayed()?cc.handleKey(a):cd.shopDisplayed()?cd.handleKey(a):ce?ce.handleInput(a):!ca&&!cb.textDisplayed()&&!b_.isAnimating()&&b$.move(0,1,l),b.preventDefault();break;case cp:console.log("up arrow"),cc.isDisplayed()?cc.handleKey(a):cd.shopDisplayed()?cd.handleKey(a):ce?ce.handleInput(a):!ca&&!cb.textDisplayed()&&!b_.isAnimating()&&b$.move(0,-1,i),b.preventDefault();break;case cr:console.log("right arrow"),cc.isDisplayed()?cc.handleKey(a):cd.shopDisplayed()?cd.handleKey(a):ce?ce.handleInput(a):!ca&&!cb.textDisplayed()&&!b_.isAnimating()&&b$.move(1,0,j),b.preventDefault();break;case cq:console.log("left arrow"),cc.isDisplayed()?cc.handleKey(a):cd.shopDisplayed()?cd.handleKey(a):ce?ce.handleInput(a):!ca&&!cb.textDisplayed()&&!b_.isAnimating()&&b$.move(-1,0,m),b.preventDefault();break;case cs:case ct:console.log("enter"),console.log(cc.isDisplayed()),cb.textDisplayed()?cb.clearText():cc.isDisplayed()?cc.handleEnter():cd.shopDisplayed()?cd.handleEnter():ce?ce.handleEnter():b_.isAnimating()||(b_.doAction(),b$.getSquareUnderfoot().onAction()),b.preventDefault();break;case cu:console.log("esc"),console.log(cc._currentMenu instanceof bc),cb.textDisplayed()?cb.clearText():cc.isDisplayed()?cc.handleESC():cd.shopDisplayed()?cd.handleESC():ce?ce.handleEsc():cc.getCurrentMenu().display(),b.preventDefault()}}}function cy(){cw=!1,ce&&ce.handleKeyUp()}function cx(a){if(!a.ctrlKey&&!a.altKey&&!a.metaKey){var b=a.keyCode?a.keyCode:a.charCode?a.charCode:0;cw=!0,cz(b,a)}}function cn(a){ca&&cc.getCurrentMenu().setOnNewGame(a)}function cm(a,b,c,d,e,f,g){a.lineWidth=g,a.strokeStyle="white";var h=b+2*g,i=c+2*g,j=b+d-2*g,k=c+e-2*g;a.beginPath(),a.moveTo(h+f,i),a.lineTo(j-f,i),a.quadraticCurveTo(j,i,j,i+f),a.lineTo(j,k-f),a.quadraticCurveTo(j,k,j-f,k),a.lineTo(h+f,k),a.quadraticCurveTo(h,k,h,k-f),a.lineTo(h,i+f),a.quadraticCurveTo(h,i,h+f,i),a.closePath(),a.shadowOffsetX=g/2,a.shadowOffsetY=g/2,a.shadowBlur=g,a.shadowColor="rgba(0, 0, 0, 0.5)";var l=a.createLinearGradient(b,c,b,c+e);l.addColorStop(0,"#0066FF"),l.addColorStop(1,"#000099"),a.fillStyle=l,a.fill(),a.stroke(),a.shadowOffsetX=0,a.shadowOffsetY=0,a.shadowBlur=0,a.shadowColor="transparent"}function cl(a){ce?ce.writeMsg(a):cb.displayText(a)}function ck(){var a=0,b=Object.keys(cH.submaps).length;for(var c=0;c<b;++c){var d=cH.submaps[c],g=d.id,i=new q(d.tileset.width,d.tileset.height,d.tileset.imgRef),j=d.xmlUrl;cg.addResource(j),ci(j,function(c,d,g,i){return function(j){cg.setLoaded(i);var k=null;d==0?(b_=new f(j,g),k=b_.getSubMap(0)):(k=new e(j,g,c.overworld),b_.addSubMap(d,k)),!c.load||c.load();var l=c.zone;if(c.randomEncounters)for(var m=0;m<k.getXLimit();++m)for(var o=0;o<k.getYLimit();++o){var p=k.getSquareAt(m,o);p.passable()&&(p.onEnter=function(){if(Math.random()<bO){cv=0,ce=new bA;var a=this.getZone();a||(a=l),ce.setupRandomEncounter(a,c.background),ce.draw()}})}var q=b_.getSubMap(d);if(c.entrances)for(var r=0;r<c.entrances.length;++r){var s=c.entrances[r],p=q.getSquareAt(s.fromX,s.fromY);p.onEnter=function(a){return function(){b_.goToMap(b$,a.toMapId,a.toX,a.toY,a.toScrollX,a.toScrollY,a.facing),!a.onEnter||a.onEnter()}}(s)}if(c.exit){function t(){b_.goToMap(b$,c.exit.toMapId,c.exit.toX,c.exit.toY,c.exit.toScrollX,c.exit.toScrollY,c.exit.facing)}var u=k.getXLimit(),v=k.getYLimit();if(c.exit.at=="edges"){for(var m=0;m<u;m++)for(var o=0;o<v;o++)if(m==0||o==0||m==u-1||o==v-1)q.getSquareAt(m,o).onEnter=t}else if(c.exit.at=="bottom"){var o=v-1;for(var m=0;m<u;m++)q.getSquareAt(m,o).onEnter=t}}if(c.npcs)for(var r=0;r<c.npcs.length;++r){var w=c.npcs[r],x=new n(w.locX,w.locY,w.imgRef,d,w.facing);x.action=function(a){return function(){this.facePlayer(),!a.callback||cb.setCallback(a.callback),cb.displayText(a.displayText)}}(w),k.addSprite(x),w.npc=x}if(c.actions)for(var r=0;r<c.actions.length;++r){var y=c.actions[r],p=q.getSquareAt(y.locX,y.locY);p.onAction=function(a){return function(){(!a.dir||a.dir==b$.getDir())&&a.onAction()}}(y)}if(c.chests)for(var r=0;r<c.chests.length;++r){var z=c.chests[r],A=new h(z.locX,z.locY,z.imgRef,d,z.event);A.action=z.action,k.addSprite(A)}++a==b&&cg.finishSetup()}}(d,g,i,j))}}function cj(){for(imgRef in cC.images){var a=cC.images[imgRef],b=a.url,c=new Image;a.img=c,cg.addResource(b,c),c.onload=function(a,b){return function(){cg.setLoaded(b),!a.load||a.load()}}(a,b),c.src=b}}function ci(a,b){$.ajax({type:"GET",url:a,dataType:"xml",async:!1,success:b,error:function(a,b,c){alert("error:"+b)}})}var a=Class.extend({_init:function(){this._lastFrameTime=Date.now()},getDelay:function(){var a=Date.now(),b=a-this._lastFrameTime,c=1e3/bM-b;c<1&&(c=1);return c},update:function(){this._lastFrameTime=Date.now()}}),b=Class.extend({_init:function(){this._resources={},this._count=0,this._loaded=0,this._setupFinished=!1;var a=this;this._failTimeout=window.setTimeout(function(){a.onFail()},bQ)},addResource:function(a,b){this._resources[a]=new c(a,b),this._count++},finishSetup:function(){this._setupFinished=!0,this.isLoadComplete()&&(window.clearTimeout(this._failTimeout),this.onComplete())},setLoaded:function(a){this._resources[a].setLoaded(),this._loaded++,this.isLoadComplete()&&(window.clearTimeout(this._failTimeout),this.onComplete())},isLoadComplete:function(){return this._setupFinished&&this._count==this._loaded},getPercentLoaded:function(){return this._loaded/this._count},getList:function(){var a=[];for(res in this._resources)this._resources[res].isLoaded()||a.push(res);return a},onComplete:function(){},onFail:function(){}}),c=Class.extend({_init:function(a,b){this._url=a,this._res=b,this._loaded=!1},isLoaded:function(){return this._loaded},setLoaded:function(){this._loaded=!0}}),d=Class.extend({_init:function(a,b,c,d,e){this._subMap=a,this._x=b,this._y=c,this._passable=d,this._zone=e},getX:function(){return this._x},getY:function(){return this._y},passable:function(){return this._passable},getZone:function(){return this._zone},onEnter:function(a){},onAction:function(a){}}),e=Class.extend({_init:function(b,c,e){this._layer=$(b).find("map layer").eq(0),this._xLimit=parseInt($(this._layer).attr("width")),this._yLimit=parseInt($(this._layer).attr("height")),this._mapXml=b,this._tileset=c,this._overworld=e,this._spriteList=[],this._mapSquares=[],this._animation=new a;var f=null;$(b).find('layer[name="Water"]').length>0&&(f=$(b).find('layer[name="Water"]').find("tile"));var g=$(b).find('layer[name="Base"]').find("tile"),h=$(b).find('layer[name="Impassable"]').find("tile"),i=$(b).find('layer[name="Zones"]');i.length>0&&(i=i.find("tile"));for(var j=0;j<this._yLimit;j++){var k=[];for(var l=0;l<this._xLimit;l++){var m=j*this._xLimit+l,n=!0;f!=null&&(n=n&&parseInt(f.eq(m).attr("gid"))==0),n=n&&parseInt(h.eq(m).attr("gid"))==0;var o=0;i.length>0&&(o=parseInt(i.eq(m).attr("gid")),o>0&&(o-=288));var p=new d(this,l,j,n,o);k.push(p)}this._mapSquares.push(k)}},getXLimit:function(){return this._xLimit},getYLimit:function(){return this._yLimit},getTileset:function(){return this._tileset},isOverWorld:function(){return this._overworld},pointInBounds:function(a,b){if(a<0||a>=this._xLimit)return!1;if(b<0||b>=this._yLimit)return!1;return!0},isPassable:function(a,b){return this._mapSquares[b][a].passable()},isOccupied:function(a,b){var c=!1;for(var d=0;d<this._spriteList.length;++d){var e=this._spriteList[d];e.isAt(a,b)&&(c=!0)}return c},getSquareAt:function(a,b){if(!this.pointInBounds(a,b))return null;return this._mapSquares[b][a]},addSprite:function(a){this._spriteList.push(a);return this._spriteList.length-1},removeSprite:function(a){var b;for(var c=0;c<this._spriteList.length;++c)this._spriteList[c]==a&&(b=c);this._spriteList.splice(b,1)},hasSprite:function(a){for(var b=0;b<this._spriteList.length;++b)if(this._spriteList[b]==a)return!0;return!1},getSpriteAt:function(a,b){for(var c=0;c<this._spriteList.length;++c){var d=this._spriteList[c];if(d.isAt(a,b))return d}return null},onEnter:function(){},onExit:function(){},drawSprites:function(){for(var a=0;a<this._spriteList.length;++a)this._spriteList[a].plot()},clearSprites:function(){for(var a=0;a<this._spriteList.length;++a)this._spriteList[a].clear()},doAction:function(){var a=b$.getFacingCoords(),b=a[0],c=a[1],d=this.getSpriteAt(b,c);d!=null&&d.action()},redraw:function(a,b,c,d){var e=this._xLimit,f=this._tileset,g=c>0?-1:0,h=d>0?-1:0,i=c<0?bE+1:bE,j=d<0?bF+1:bF;$(this._mapXml).find("map layer").each(function(){var k=$(this).attr("visible");if(k!="0"){var l=$(this).find("tile");for(var m=h;m<j;++m)for(var n=g;n<i;++n){var o=(m+b)*e+n+a,p=l.eq(o).attr("gid");p>0&&f.drawClip(p,n,m,c,d)}}})},animate:function(a,b,c,d){b_.startAnimating(),b_.startScrolling();var e=c-a,f=d-b,g=(f!=0?bD:bC)/bN,h=this;h.animateSub(a,b,0,0,e,f,g)},animateSub:function(a,b,c,d,e,f,g){this._animation.update();if(g>0){for(var h=0;h<this._spriteList.length;++h)this._spriteList[h].clear(c+e*bC,d+f*bD);c-=e*bN,d-=f*bN;for(var h=0;h<this._spriteList.length;++h)this._spriteList[h].plot(0,0,c+e*bC,d+f*bD);this._lastOffsetX=c+e*bC,this._lastOffsetY=d+f*bD}this.redraw(a,b,c,d);if(g>0){var i=this;window.setTimeout(function(){i.animateSub(a,b,c,d,e,f,--g)},this._animation.getDelay())}else b_.finishAnimating(),b_.finishScrolling(),this._lastOffsetX=undefined,this._lastOffsetY=undefined,cA()}}),f=Class.extend({_init:function(a,b){this._subMapList=[],this._currentSubMap=0,this._scrollX=0,this._scrollY=0;var c=new e(a,b,!0);this._subMapList[0]=c,this._animating=!1,this._scrolling=!1,this._runAfterAnimation=null},getSubMap:function(a){return this._subMapList[a]},getScrollX:function(){return this._scrollX},getScrollY:function(){return this._scrollY},getCurrentSubMapId:function(){return this._currentSubMap},getXLimit:function(){return this._subMapList[this._currentSubMap].getXLimit()},getYLimit:function(){return this._subMapList[this._currentSubMap].getYLimit()},isOverWorld:function(){return this._subMapList[this._currentSubMap].isOverWorld()},pointInBounds:function(a,b){return this._subMapList[this._currentSubMap].pointInBounds(a,b)},isPassable:function(a,b){return this._subMapList[this._currentSubMap].isPassable(a,b)},isOccupied:function(a,b){return this._subMapList[this._currentSubMap].isOccupied(a,b)},getSquareAt:function(a,b){var c=this._subMapList[this._currentSubMap].getSquareAt(a,b);return c},transform:function(a,b){var c=bC*(a-this._scrollX),d=bD*(b-this._scrollY);return[c,d]},isOnScreen:function(a,b){var c=a-this._scrollX,d=b-this._scrollY;return c>=-1&&c<=bE&&d>=-1&&d<=bF+1},autoScrollToPlayer:function(a,b){var c=!1,d=a-this._scrollX,e=b-this._scrollY,f=0;d<bG?c=this.scroll(d-bG,0)||c:d>bH&&(c=this.scroll(d-bH,0)||c),e<bI?c=this.scroll(0,e-bI)||c:e>bJ&&(c=this.scroll(0,e-bJ)||c);return c},scroll:function(a,b){var c=this._scrollX+a,d=this._scrollY+b,e=this.getXLimit(),f=this.getYLimit();c<0&&(c=0),c+bE>e&&(c=e-bE),d<0&&(d=0),d+bF>f&&(d=f-bF);if(c!=this._scrollX||d!=this._scrollY){var g=this._scrollX,h=this._scrollY;this._scrollX=c,this._scrollY=d,this.animate(g,h,c,d);return!0}return!1},redraw:function(){this._subMapList[this._currentSubMap].redraw(this._scrollX,this._scrollY,0,0)},animate:function(a,b,c,d){this._subMapList[this._currentSubMap].animate(a,b,c,d)},addSubMap:function(a,b){this._subMapList[a]=b},goToMap:function(a,b,c,d,e,f,g){a.clear();var h=this._subMapList[this._currentSubMap];h.onExit(),h.clearSprites(),bU.clearRect(0,0,bT.width,bT.height),this._currentSubMap=b,a.enterNewSubMap(b,c,d,g),this.goTo(e,f);var i=this._subMapList[b];i.drawSprites(),i.onEnter(),a.plot()},goTo:function(a,b){this._scrollX=a,this._scrollY=b,this.redraw()},doAction:function(){this._subMapList[this._currentSubMap].doAction()},drawSprites:function(){this._subMapList[this._currentSubMap].drawSprites()},clearSprites:function(){this._subMapList[this._currentSubMap].clearSprites()},isAnimating:function(){return this._animating},startAnimating:function(){this._animating=!0},finishAnimating:function(){this._animating=!1,this._runAfterAnimation&&(this._runAfterAnimation(),this._runAfterAnimation=null)},isScrolling:function(){return this._scrolling},startScrolling:function(){this._scrolling=!0},finishScrolling:function(){this._scrolling=!1},runAfterAnimation:function(a){this._runAfterAnimation||(this._runAfterAnimation=a)},createSaveData:function(){return{scrollX:this._scrollX,scrollY:this._scrollY}},loadSaveData:function(a){this._scrollX=a.scrollX,this._scrollY=a.scrollY}}),g=Class.extend({_init:function(a,b,c,d,e,f,g,h){this._x=a,this._y=b,this._width=c,this._height=d,this._subMap=f,this._img=cC.images[e].img,this._sx=g!=undefined?g:0,this._sy=h!=undefined?h:0},getX:function(){return this._x},getY:function(){return this._y},getSubMap:function(){return this._subMap},isAt:function(a,b){return this._x==a&&this._y==b},plot:function(a,b,c,d){if(b_.getCurrentSubMapId()==this._subMap){if(!b_.isOnScreen(this._x,this._y))return;var e=this._width,f=this._height,g=this._width,h=this._height,i=b_.getSubMap(this._subMap);i.isOverWorld()&&(g=Math.ceil(bC*bD/bL),h=bD);var j=b_.transform(this._x,this._y),k=j[0],l=j[1];k+=Math.floor((bC-g)/2),l+=bD-h;var m=this._sx;a!=undefined&&(m+=a);var n=this._sy;b!=undefined&&(n+=b),c!=undefined&&(k+=c),d!=undefined&&(l+=d),bU.drawImage(this._img,m,n,e,f,k,l,g,h);if(!i.isOverWorld())if(this==b$){var o=i.getSpriteAt(this._x,this._y+1);o!=null&&(b_.isScrolling()?i._lastOffsetX!=undefined&&o.plot(0,0,i._lastOffsetX,i._lastOffsetY):o.plot());var o=i.getSpriteAt(this._prevX,this._prevY+1);o!=null&&(b_.isScrolling()?i._lastOffsetX!=undefined?o.plot(0,0,i._lastOffsetX,i._lastOffsetY):o.plot(0,0,(this._x-this._prevX)*bC,(this._y-this._prevY)*bD):o.plot())}else b$.isAt(this._x,this._y+1)&&b$.plot()}},clear:function(a,b){if(b_.getCurrentSubMapId()==this._subMap){if(!b_.isOnScreen(this._x,this._y))return;var c=b_.transform(this._x,this._y),d=c[0],e=c[1],f=this._width,g=this._height,h=b_.getSubMap(this._subMap);h.isOverWorld()&&(f=Math.ceil(bC*bD/bL),g=bD),d+=Math.floor((bC-f)/2),e+=bD-g,a!=undefined&&(d+=a),b!=undefined&&(e+=b),bU.clearRect(d,e,f,g);if(!h.isOverWorld())if(this==b$){var i=h.getSpriteAt(this._x,this._y-1);i!=null&&(b_.isScrolling()?h._lastOffsetX!=undefined&&i.plot(0,0,h._lastOffsetX,h._lastOffsetY):i.plot());var i=h.getSpriteAt(this._prevX,this._prevY-1);i!=null&&(b_.isScrolling()?h._lastOffsetX!=undefined&&i.plot(0,0,h._lastOffsetX,h._lastOffsetY):i.plot());var j=h.getSpriteAt(this._prevX,this._prevY+1);j!=null&&(b_.isScrolling()?h._lastOffsetX!=undefined&&j.plot(0,0,h._lastOffsetX,h._lastOffsetY):j.plot())}else b_.isScrolling()||(b$.isAt(this._x,this._y-1)&&b$.plot(),b$.isAt(this._x,this._y+1)&&b$.plot())}},action:function(){}}),h=g.extend({_init:function(a,b,c,d,e){this._super(a,b,bC,bD,c,d),this._flagName=e,this._open=!1;var f=this;bZ.addLoadFunction(function(){bZ.isFlagSet(f._flagName)?f._open=!0:f._open=!1})},isOpen:function(){return this._open},open:function(){this.clear(),this._open=!0,bZ.setFlag(this._flagName),this.plot()},plot:function(a,b,c,d){var e=0;this._open&&(e=bC),this._super(e,0,c,d)},onOpenFindItem:function(a,b,c){this.isOpen()||(this.open(),b$.addToInventory(b,c),cb.displayText(a))},onOpenLearnSpell:function(a){if(!this.isOpen()){this.open(),b$.learnSpell(a);var b="You found a spell book.\n",c=du.spells[a].name;b+="You learned "+c+".",cb.displayText(b)}}}),i=0,j=1,l=2,m=3,n=g.extend({_init:function(a,b,c,d,e){this._super(a,b,bK,bL,c,d),this._dir=e,this._walking=!1,this._entered=!1},getDir:function(){return this._dir},getFacingCoords:function(){var a=this._x,b=this._y;switch(this._dir){case i:b--;break;case l:b++;break;case m:a--;break;case j:a++}return[a,b]},facePlayer:function(){switch(b$.getDir()){case i:this._dir=l;break;case l:this._dir=i;break;case m:this._dir=j;break;case j:this._dir=m}this.clear(),this.plot()},plot:function(a,b,c,d){if(!this._walking||c!==undefined||d!==undefined){var e=bL*this._dir,f=bK;a!=undefined&&(f+=a),this._super(f,e,c,d)}},move:function(a,b,c){this._dir=c;var d=this._x+a,e=this._y+b;if(!b_.pointInBounds(d,e)||!b_.isPassable(d,e)||b_.isOccupied(d,e)){b_.isAnimating()||(this.clear(),this.plot());return!1}this.clear(),this._prevX=this._x,this._prevY=this._y,this._x+=a,this._y+=b;if(this==b$){var f=b_.autoScrollToPlayer(this._x,this._y);f?this.scrollAnimation():this.walkAnimation(a,b),this._entered=!1;var g=this;b_.runAfterAnimation(function(){g._entered||g.getSquareUnderfoot().onEnter(),g._entered=!0})}return!0},enterNewSubMap:function(a,b,c,d){this._x=b,this._y=c,this._dir=d,this._subMap=a},getSquareUnderfoot:function(){return b_.getSquareAt(this._x,this._y)},scrollAnimation:function(){b_.isScrolling()&&this.scrollAnimationSub(0)},scrollAnimationSub:function(a){if(b_.isScrolling()&&!ce){this.clear();var b=0;if(a==2||a==3)b=-bK;else if(a==6||a==7)b=bK;this.plot(b);var c=this;window.setTimeout(function(){c.scrollAnimationSub((a+1)%8)},1e3/bM)}else ce||(this.clear(),this.plot())},walkAnimation:function(a,b){if(b_.isAnimating()){var c=this;b_.runAfterAnimation(function(){c.walkAnimation(a,b)})}else if(!ce){b_.startAnimating(),this._walking=!0;var d=(b!=0?bD:bC)/bN,e=-a*bC,f=-b*bD;this.walkAnimationSub(0,a,b,e,f,d)}},walkAnimationSub:function(a,b,c,d,e,f){if(f>1&&!ce){this.clear(d,e);var g=0;if(a==2||a==3)g=-bK;else if(a==6||a==7)g=bK;d+=b*bN,e+=c*bN,this.plot(g,0,d,e);var h=this;window.setTimeout(function(){h.walkAnimationSub((a+1)%8,b,c,d,e,--f)},1e3/bM)}else this._walking=!1,ce||(this.clear(d,e),this.plot()),b_.finishAnimating(),ce||cA()}}),o=n.extend({_init:function(a,b,c,d,e,f){this._super(a,b,c,d,e),this._player=dw.players[f],this.reset()},reset:function(){this._name=this._player.name,this._exp=this._player.exp,this._gold=this._player.gold,this._level=this._player.level,this._maxHP=this._player.maxHP,this._maxMP=this._player.maxMP,this._hp=this._player.maxHP,this._mp=this._player.maxMP,this._attack=this._player.attack,this._defense=this._player.defense,this._levels=this._player.levels,this._weapon=this._player.weapon,this._armor=this._player.armor,this._helmet=this._player.helmet,this._shield=this._player.shield,this._inventory=this._player.inventory,this._spells=this._player.spells},getName:function(){return this._name},getExp:function(){return this._exp},getNextExp:function(){return this._levels[this._level]},getGold:function(){return this._gold},getMaxHP:function(){return this._maxHP},getMaxMP:function(){return this._maxMP},getHP:function(){return this._hp},getMP:function(){return this._mp},getAttack:function(){return this._attack+dm.items[this._weapon].attack},getDefense:function(){return this._defense+dm.items[this._armor].defense+dm.items[this._helmet].defense+dm.items[this._shield].defense},getLevel:function(){return this._level},getWeapon:function(){return this._weapon},getArmor:function(){return this._armor},getHelmet:function(){return this._helmet},getShield:function(){return this._shield},isDead:function(){return this._hp<=0},damage:function(a){this._hp-=a},heal:function(a){this._hp+=a,this._hp>this._maxHP&&(this._hp=this._maxHP)},useMP:function(a){this._mp-=a},gainMP:function(a){this._mp+=a,this._mp>this._maxMP&&(this._mp=this._maxMP)},restore:function(){this._hp=this._maxHP,this._mp=this._maxMP},earnExp:function(a){this._exp+=a;if(this._level<this._player.max_levels&&this._exp>=this.getNextExp()){this._level++,this._attack+=this._player.attack_increase,this._defense+=this._player.defense_increase,this._maxHP+=this._player.maxHP_increase,this._maxMP+=this._player.maxMP_increase;return!0}return!1},earnGold:function(a){this._gold+=a},spendGold:function(a){this._gold-=a},equipWeapon:function(a){this._weapon=a},equipArmor:function(a){this._armor=a},equipHelmet:function(a){this._helmet=a},equipShield:function(a){this._shield=a},addToInventory:function(a,b){b==undefined&&(b=1),this._inventory[a]?this._inventory[a]+=b:this._inventory[a]=b},numInInventory:function(a){return parseInt(this._inventory[a])},removeFromInventory:function(a,b){b==undefined&&(b=1),this._inventory[a]-=b},forEachItemInInventory:function(a){for(var b in this._inventory)a(b,this._inventory[b])},learnSpell:function(a){this._spells.push(a)},forEachSpell:function(a){for(var b in this._spells)a(b)},createSaveData:function(){return{exp:this._exp,gold:this._gold,level:this._level,maxHP:this._maxHP,maxMP:this._maxMP,hp:this._hp,mp:this._mp,attack:this._attack,defense:this._defense,weapon:this._weapon,armor:this._armor,helmet:this._helmet,shield:this._shield,inventory:this._inventory,spells:this._spells,x:this._x,y:this._y,subMap:this._subMap,dir:this._dir}},loadSaveData:function(a){this._exp=a.exp,this._gold=a.gold,this._level=a.level,this._maxHP=a.maxHP,this._maxMP=a.maxMP,this._hp=a.hp,this._mp=a.mp,this._attack=a.attack,this._defense=a.defense,this._weapon=a.weapon,this._armor=a.armor,this._helmet=a.helmet,this._shield=a.shield,this._inventory=a.inventory,this._spells=a.spells,this._x=a.x,this._y=a.y,this._subMap=a.subMap,this._dir=a.dir}}),p=Class.extend({_init:function(a){this._monster=a,this._maxHP=a.hp,this._hp=a.hp,this._loc=0},getHP:function(){return this._hp},damage:function(a){this._hp-=a},heal:function(a){this._hp+=a,this._hp>this._maxHP&&(this._hp=this._maxHP)},isDead:function(){return this._hp<=0},getLoc:function(){return this._loc},setLoc:function(a){this._loc=a},getName:function(){return this._monster.name},getAttack:function(){return this._monster.attack},getDefense:function(){return this._monster.defense},getExp:function(){return this._monster.exp},getGold:function(){return this._monster.gold},getImageRef:function(){return this._monster.imgRef},getLeft:function(){return this._monster.left},getTop:function(){return this._monster.top},getWidth:function(){return this._monster.width},getHeight:function(){return this._monster.height},hasSpecialAttack:function(){return!!this._monster.special},useSpecialAttack:function(){this._monster.special(this)}}),q=Class.extend({_init:function(a,b,c){this._width=a,this._height=b,this._url=cC.images[c].url,this._img=cC.images[c].img},drawClip:function(a,b,c,d,e){var a=parseInt(a);a--;var f=bC,g=bD,h=this._width/f,i=a%h*f,j=Math.floor(a/h)*g,k=b*f+d,l=c*g+e;bS.drawImage(this._img,i,j,f,g,k,l,f,g)}}),r=Class.extend({_init:function(){this._textDisplayed=!1,this._callback=null},setCallback:function(a){this._callback=a},textDisplayed:function(){return this._textDisplayed},displayText:function(a){bY.fillStyle="rgba(0, 0, 100, 0.75)",bY.fillRect(0,236,bX.width,100),bY.fillStyle="white",bY.font="bold 16px monospace",bY.textBaseline="top";var b=a.split("\n"),c=0;do bY.fillText(b[c],10,246+22*c);while(b.length>++c);this._textDisplayed=!0},clearText:function(){bY.clearRect(0,236,bX.width,100),this._textDisplayed=!1,this._callback&&(this._callback(),this._callback=null)}}),s=Class.extend({_init:function(a){this._type=a.type,this._displayed=!1,this._num=a.numberSelections,this._drawBox=a.drawBox,this._left=a.left,this._top=a.top,this._width=a.width,this._height=a.height,this._radius=a.radius,this._thickness=a.thickness,this._textLeft=a.textLeft,this._heights=a.heights,this._texts=a.texts,this._font=a.font,this._canESC=!0,this._beforeCallback=a.beforeCallback?a.beforeCallback:function(){},this._afterCallback=a.afterCallback?a.afterCallback:function(){},this._beforeClear=a.beforeClear?a.beforeClear:function(){},this._afterClear=a.afterClear?a.afterClear:function(){}},display:function(){console.log("AbstractMenu.display"),this._drawBox&&cm(bW,this._left,this._top,this._width,this._height,this._radius,this._thickness),bY.font=this._font,bY.textBaseline="top",this.drawText(),this._num>0&&this.drawPointer(),this._displayed=!0},isDisplayed:function(){return this._displayed},clear:function(){this._drawBox&&bW.clearRect(this._left,this._top,this._width,this._height),bY.clearRect(this._left,this._top,this._width,this._height),this._displayed=!1},getType:function(){return this._type},drawPointer:function(){},clearPointer:function(){},drawText:function(){for(var a=0;a<this._num;++a)bY.fillText(this._texts[a],this._textLeft,this._heights[a])},handleKey:function(a){},handleEnter:function(){this._beforeCallback(),this.handleESC(),this._afterCallback()},handleESC:function(){this._displayed&&this._canESC&&(this._beforeClear(),this.clear(),this._afterClear())}}),t=s.extend({_init:function(a){this._super(a),this._current=0,this._pointer=!1,this._pointerLeft=a.pointerLeft,this._flags=a.flags,this._callbacks=a.callbacks,this._canESC=a.canESC},drawPointer:function(){console.log("Menu.drawPointer:"+this._current);var a=this._heights[this._current%this._num],b=cC.images.pointer.img;bY.drawImage(b,this._pointerLeft,a+2),this._pointer=!0},clearPointer:function(){console.log("Menu.clearPointer:"+this._current);var a=this._heights[this._current%this._num];bY.clearRect(this._pointerLeft,a+2,16,11),this._pointer=!1},drawText:function(){for(var a=0;a<this._num;++a)bY.fillStyle=this._flags?this._flags[a]?"gray":"white":"white",bY.fillText(this._texts[a],this._textLeft,this._heights[a])},handleKey:function(a){console.log("Menu.handleKey:"+a+this._displayed);if(this._displayed){this.clearPointer();switch(a){case co:case cr:this._current++,this._current%=this._num;break;case cp:case cq:this._current--,this._current<0&&(this._current+=this._num)}this.drawPointer()}},handleEnter:function(){console.log("Menu.handleEnter"),this._displayed&&(this._flags&&this._flags[this._current]?console.log("flags"):this._num>0?(console.log("callbacks:"+this._current),this._beforeCallback(),this._callbacks[this._current](),this._afterCallback()):this.handleESC())},createCallbacks:function(a){var b=[],c=this;for(var d=0;d<a;++d)b[d]=function(a){return function(){c.callback(a)}}(d);return b}}),u=t.extend({_init:function(a){this._mainMenu=a,this._items=[];var b=this._getItems(),c=this._getTexts(),d=this._getFlags(),e=this.createCallbacks(b),f=this;this._super({type:M,numberSelections:b,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:186,heights:[20,48,76,104,132,160],texts:c,flags:d,font:"bold 20px monospace",callbacks:e,canESC:!0,afterCallback:function(){f._mainMenu.setCurrentMenu(f._mainMenu)},afterClear:function(){f._mainMenu.returnTo()}})},_getItems:function(){var a=0,b=this;b$.forEachItemInInventory(function(c,d){if(d>0){var e={};e.name=dm.items[c].name,e.type=dm.items[c].type,e.amt=d,e.id=c,e.canUse=e.type==cJ,b._items.push(e),a++}});return a},_getTexts:function(){var a=[];for(var b=0;b<this._items.length;++b){var c=this._items[b],d=c.amt<10?" "+c.amt:c.amt;a[b]=c.name+":"+d}return a},_getFlags:function(){return _.map(this._items,function(a,b){return!a.canUse})},callback:function(a){var b=this._items[a];this.clear(),this._mainMenu.clear();var c=dm.items[b.id];c.use(b$),b$.removeFromInventory(b.id)}}),v=t.extend({_init:function(a){this._mainMenu=a,this._spells=[];var b=this._getSpells(),c=this._getTexts(),d=this._getFlags(),e=this.createCallbacks(b),f=this;this._super({type:N,numberSelections:b,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:186,heights:[20,48,76,104,132,160],texts:c,flags:d,font:"bold 20px monospace",callbacks:e,canESC:!0,afterCallback:function(){f._mainMenu.setCurrentMenu(f._mainMenu)},afterClear:function(){f._mainMenu.returnTo()}})},_getSpells:function(){var a=0,b=this;b$.forEachSpell(function(c){var d={};d.name=du.spells[c].name,d.type=du.spells[c].type,d.id=c,d.canUse=d.type==dq,b._spells.push(d),a++});return a},_getTexts:function(){var a=[];for(var b=0;b<this._spells.length;++b){var c=this._spells[b];a[b]=c.name}return a},_getFlags:function(){return _.map(this._spells,function(a,b){return!a.canUse})},callback:function(a){var b=this._spells[a];this.clear(),this._mainMenu.clear();var c=du.spells[b.id];b$.getMP()>=c.mpCost?(c.use(b$),b$.useMP(c.mpCost)):cb.displayText("You do not have enough mp to use "+b.name+".")}}),w=4,x=0,y=1,z=2,A=3,B=t.extend({_init:function(a){this._mainMenu=a;var b=this.createCallbacks(w),c=this;this._super({type:O,numberSelections:w,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[20,60,100,140],font:"bold 16px monospace",callbacks:b,canESC:!0,afterClear:function(){c._mainMenu.returnTo()}})},drawText:function(){bY.fillText("Weapon:",this._textLeft,this._heights[0]),bY.fillText(dm.items[b$.getWeapon()].name,210,40),bY.fillText("Armor:",this._textLeft,this._heights[1]),bY.fillText(dm.items[b$.getArmor()].name,210,80),bY.fillText("Helmet:",this._textLeft,this._heights[2]),bY.fillText(dm.items[b$.getHelmet()].name,210,120),bY.fillText("Shield:",this._textLeft,this._heights[3]),bY.fillText(dm.items[b$.getShield()].name,210,160)},callback:function(a){console.log("Equip callback");var b=new C(this._mainMenu,this,a);b.display(),this._mainMenu.setCurrentMenu(b)},returnTo:function(){console.log("EquipMenu.returnTo"),this.clear(),this.display(),this._mainMenu.setCurrentMenu(this)}}),C=t.extend({_init:function(a,b,c){this._mainMenu=a,this._equipType=c,this._parent=b;var d=this._getItems(),e=this._getTexts(),f=this.createCallbacks(d),g=this;this._super({type:T,numberSelections:d,drawBox:!0,left:150,top:200,width:250,height:150,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[220,240,260,280,300],texts:e,font:"bold 16px monospace",callbacks:f,canESC:!0,afterCallback:function(){},afterClear:function(){g._parent.returnTo()}})},_getEquivType:function(a){switch(a){case x:return cL;case y:return cM;case z:return cN;case A:return cO}},_getItems:function(){var a=this._getEquivType(this._equipType);this._items=[];var b=0,c=this;b$.forEachItemInInventory(function(d,e){if(e>0){var f=dm.items[d].type;if(f==a){var g={};g.name=dm.items[d].name,g.type=f,g.amt=e,g.id=d,c._items.push(g),b++}}}),console.log("EquipSubMenu numItems: "+b);return b},_getTexts:function(){var a=[];for(var b=0;b<this._items.length;++b){var c=this._items[b];a[b]=c.name}return a},callback:function(a){this.changeEquip(a),this.clear(),this._parent.returnTo()},changeEquip:function(a){var b,c=this._items[a].id;switch(this._equipType){case x:b=b$.getWeapon(),b$.equipWeapon(c);break;case y:b=b$.getArmor(),b$.equipArmor(c);break;case z:b=b$.getHelmet(),b$.equipHelmet(c);break;case A:b=b$.getShield(),b$.equipShield(c)}b$.removeFromInventory(c),b$.addToInventory(b)}}),D=4,E=t.extend({_init:function(a){this._mainMenu=a;var b=this.createCallbacks(D),c=this;this._super({numberSelections:D,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,pointerLeft:170,textLeft:195,heights:[20,60,100,140],font:"bold 16px monospace",callbacks:b,canESC:!0,afterCallback:function(){c._mainMenu.setCurrentMenu(c._mainMenu)},afterClear:function(){c._mainMenu.returnTo()}})}}),F=E.extend({_init:function(a){this._super(a),this._type=Q},drawText:function(){for(var a=1;a<=D;++a)bY.font="bold 16px monospace",bY.fillText("Save Slot "+a+":",this._textLeft,this._heights[a-1]),bZ.hasSaveInfo(a)?(bY.font="bold 14px monospace",bY.fillText(bZ.getSaveInfo(a),this._textLeft+15,this._heights[a-1]+20)):(bY.font="italic 14px serif",bY.fillText("Empty",this._textLeft+15,this._heights[a-1]+20))},callback:function(a){this.clear(),this._mainMenu.clear();var b=a+1;bZ.save(b),cb.displayText("Game saved to slot "+b+".")}}),G=E.extend({_init:function(a){this._super(a),this._type=R;var b=this;this._afterCallback=function(){ca?(ca=!1,cc.setCurrentMenu(cc)):cc.setCurrentMenu(a)}},drawText:function(){for(var a=1;a<=D;++a)bZ.hasSaveInfo(a)?(bY.font="bold 16px monospace",bY.fillStyle="white",bY.fillText("Save Slot "+a+":",195,40*a-20),bY.font="bold 14px monospace"
,bY.fillText(bZ.getSaveInfo(a),210,40*a)):(bY.font="bold 16px monospace",bY.fillStyle="gray",bY.fillText("Save Slot "+a+":",195,40*a-20),bY.font="italic 14px serif",bY.fillText("Empty",210,40*a))},callback:function(a){this.clear(),this._mainMenu.clear(),console.log("LoadMenu callback slot:"+a+1),this.loadGame(a+1)},loadGame:function(a){try{bZ.load(a),bU.clearRect(0,0,bT.width,bT.height),b_.goToMap(b$,b$.getSubMap(),b$.getX(),b$.getY(),b_.getScrollX(),b_.getScrollY(),b$.getDir())}catch(b){if(b instanceof br)cb.displayText("There is no saved game in slot"+a+".");else if(b instanceof bs)cb.displayText("The game saved is from an old,\nincompatible version.");else throw b}}}),H=2,I=0,J=1,K=t.extend({_init:function(a){var b=this;this._mainMenu=a,this._super({type:U,numberSelections:H,drawBox:!0,left:0,top:0,width:175,height:90,radius:25,thickness:4,pointerLeft:24,textLeft:44,heights:[20,48],texts:["New Game","Load Game"],font:"bold 20px monospace",callbacks:[function(){b.onNewGame()},function(){b.displayLoadMenu()}],canESC:!0,afterClear:function(){cc.clearTitleScreenMenu()}}),this._onNewGame=null,this._currentMenu=this},display:function(){this._mainMenu.setDisplayed(!0),this._super()},clear:function(){this._mainMenu.setDisplayed(!1),this._super()},onNewGame:function(){console.log(this instanceof Class),this.clear(),this._onNewGame(),ca=!1,this._mainMenu.setCurrentMenu(this._mainMenu)},setOnNewGame:function(a){this._onNewGame=a},returnTo:function(){this._currentMenu=this,this.display(),this.drawPointer()},displayLoadMenu:function(){var a=new G(this);a.display(),this._currentMenu=a},handleKey:function(a){console.log("TitleScreenMenu.handleKey"),this._currentMenu==this?this._super(a):this._currentMenu.handleKey(a)},handleEnter:function(){console.log("TitleScreenMenu.handleEnter"),this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){this._currentMenu==this?this._super():this._currentMenu.handleESC()},getCurrentMenu:function(){return this._mainMenu.getCurrentMenu()},setCurrentMenu:function(a){this._mainMenu.setCurrentMenu(a)},returnTo:function(){console.log("TitleScreenMenu.returnTo"),this._mainMenu.setCurrentMenu(this),this.display(),this.drawPointer()},setDisplayed:function(a){this._displayed=a}}),L=0,M=1,N=2,O=3,P=4,Q=5,R=6,S=7,T=8,U=9,V=0,W=1,X=2,Y=3,Z=4,ba=5,bb=6,bc=t.extend({_init:function(){var a=this;this._super({type:L,numberSelections:bb,drawBox:!0,left:0,top:0,width:150,height:200,radius:25,thickness:4,pointerLeft:24,textLeft:42,heights:[20,48,76,104,132,160],texts:["Item","Spell","Equip","Status","Save","Load"],font:"bold 20px monospace",callbacks:[function(){a.displayItemMenu()},function(){a.displaySpellMenu()},function(){a.displayEquipMenu()},function(){a.displayStatusMenu()},function(){a.displaySaveMenu()},function(){a.displayLoadMenu()}],canESC:!0}),ca?(this._currentMenu=new K(this),this._titleScreenMenu=this._currentMenu):this._currentMenu=this},getCurrentMenu:function(){return this._currentMenu},setCurrentMenu:function(a){this._currentMenu=a},returnTo:function(){console.log("MainMenu.returnTo"),this._currentMenu=this,this.clear(),this.display(),this.drawPointer()},setDisplayed:function(a){this._displayed=a},displayTitleScreenMenu:function(){var a=this._titleScreenMenu?this._titleScreenMenu:new K(this);a.display(),this._currentMenu=a,this._displayed=!0},clearTitleScreenMenu:function(){this._displayed=!1},displayNotImplementedMenu:function(){var a=new bd(this);a.display(),this._currentMenu=a},displayItemMenu:function(){var a=new u(this);a.display(),this._currentMenu=a},displaySpellMenu:function(){var a=new v(this);a.display(),this._currentMenu=a},displayEquipMenu:function(){var a=new B(this);a.display(),this._currentMenu=a},displayStatusMenu:function(){var a=new be(this);a.display(),this._currentMenu=a},displaySaveMenu:function(){var a=new F(this);a.display(),this._currentMenu=a},displayLoadMenu:function(){var a=new G(this);a.display(),this._currentMenu=a},handleKey:function(a){console.log("MainMenu.handleKey"),this._currentMenu==this?this._super(a):this._currentMenu.handleKey(a)},handleEnter:function(){console.log("MainMenu.handleEnter"),console.log("current menu: "+this._currentMenu.getType()),this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){console.log("MainMenu.handleESC: "+(this instanceof bc)+" "+(this._currentMenu==this)),this._currentMenu==this?this._super():this._currentMenu.handleESC()}}),bd=s.extend({_init:function(a){this._mainMenu=a;var b=this;this._super({type:S,numberSelections:0,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,textLeft:170,heights:[],texts:[],font:"bold 20px monospace",afterClear:function(){b._mainMenu.returnTo()}})}}),be=s.extend({_init:function(a){this._mainMenu=a;var b=this._getTexts(),c=this;this._super({type:P,numberSelections:7,drawBox:!0,left:150,top:0,width:250,height:200,radius:25,thickness:4,textLeft:180,heights:[18,36,54,72,90,108,126],texts:b,font:"bold 14px monospace",afterCallback:function(){c._mainMenu.setCurrentMenu(c._mainMenu)},afterClear:function(){c._mainMenu.returnTo()}})},_getTexts:function(){var a=[];a[0]="HP:      "+b$.getHP()+"/"+b$.getMaxHP(),a[1]="MP:      "+b$.getMP()+"/"+b$.getMaxMP(),a[2]="Attack:  "+b$.getAttack(),a[3]="Defense: "+b$.getDefense(),a[4]="Level:   "+b$.getLevel(),a[5]="Exp:     "+b$.getExp()+"/"+b$.getNextExp(),a[6]="Gold:    "+b$.getGold();return a}}),bf=t.extend({_init:function(a,b,c){console.log("BuyMenu._init");var d=this;this._parent=a,this._shop=b,this._itemList=c,this._items=[];var e=this._getItems(),f=this._getTexts(),g=this.createCallbacks(e);this._super({type:bi,numberSelections:e,drawBox:!0,left:100,top:0,width:300,height:250,radius:40,thickness:5,pointerLeft:124,textLeft:144,heights:[35,55,75,95,115,135,155,175,195,215],texts:f,font:"bold 16px monospace",callbacks:g,canESC:!0,afterClear:function(){d._parent.returnTo()}})},_getItems:function(){var a=0,b=this;for(var c=0;c<this._itemList.length;++c){var d=this._itemList[c],e={};e.name=dm.items[d].name,e.type=dm.items[d].type,e.cost=dm.items[d].cost,e.id=d,b._items.push(e),a++}console.log("BuyMenu._getItems: numItems: "+a);return a},_getTexts:function(){var a=[];for(var b=0;b<this._items.length;++b){var c=this._items[b],d=c.name;while(d.length<15)d+=" ";var e=c.cost;while(e.length<5)e=" "+e;a[b]=d+e}return a},callback:function(a){this._shop.handlePurchase(this._items[a])}}),bg=t.extend({_init:function(a,b){var c=this;this._parent=a,this._shop=b,this._items=[];var d=this._getItems(),e=this._getTexts(),f=this.createCallbacks(d);this._super({type:bj,numberSelections:d,drawBox:!0,left:100,top:0,width:300,height:250,radius:40,thickness:5,pointerLeft:124,textLeft:144,heights:[35,55,75,95,115,135,155,175,195,215],texts:e,font:"bold 14px monospace",callbacks:f,canESC:!0,afterClear:function(){c._parent.returnTo()}})},_getItems:function(){var a=0,b=this;b$.forEachItemInInventory(function(c,d){if(d>0){var e={};e.id=c,e.name=dm.items[c].name,e.amt=d,e.cost=dm.items[c].cost,e.sellPrice=Math.floor(e.cost*cI),console.log("item.sellPrice: "+e.sellPrice),b._items.push(e),a++}});return a},_getTexts:function(){var a=[];for(var b=0;b<this._items.length;++b){var c=this._items[b],d=c.amt,e=d>=10?d:" "+d,f=c.sellPrice.toString();while(f.length<5)f=" "+f;var g=c.name;while(g.length<15)g+=" ";a[b]=g+" "+e+" "+f+"G"}return a},callback:function(a){this._shop.handleSale(this._items[a])}}),bh=0,bi=1,bj=2,bk=3,bl=0,bm=1,bn=2,bo=t.extend({_init:function(a){this._shop=a;var b=this;this._super({type:bh,numberSelections:bk,drawBox:!0,left:0,top:0,width:100,height:100,radius:15,thickness:3,pointerLeft:13,textLeft:32,heights:[12,40,68],texts:["Buy","Sell","Exit"],font:"bold 20px monospace",callbacks:[function(){b.displayBuyMenu()},function(){b.displaySellMenu()},function(){b.handleESC()}],afterClear:function(){b.afterClear()},canESC:!0}),this._currentMenu=this},getShop:function(){return this._shop},returnTo:function(){console.log("ShopMenu.returnTo"),this._currentMenu=this,this.clear(),this.display(),this.drawPointer()},afterClear:function(){cb.displayText("Thank you for your business.\nPlease come again.")},display:function(){this._super(),this.displayGold()},clear:function(){this._super(),this.clearGold()},displayGold:function(){cm(bW,0,120,100,40,10,2),bY.font="bold 20px monospace",bY.fillStyle="white",bY.textBaseline="top",bY.fillText(b$.getGold()+"G",16,130)},clearGold:function(){bW.clearRect(0,120,100,50),bY.clearRect(0,120,100,50)},displayBuyMenu:function(){console.log("ShopMenu.displayBuyMenu: itemList length: "+this.getShop().getItemList().length);var a=new bf(this,this.getShop(),this.getShop().getItemList());a.display(),this._currentMenu=a},displaySellMenu:function(){var a=new bg(this,this.getShop());a.display(),this._currentMenu=a},getCurrentMenu:function(){return this._currentMenu},setCurrentMenu:function(a){this._currentMenu=a},handleKey:function(a){console.log("ShopMenu.handleKey"),this._currentMenu==this?this._super(a):this._currentMenu.handleKey(a)},handleEnter:function(){console.log("ShopMenu.handleEnter"),console.log("current menu: "+this._currentMenu.getType()),this._currentMenu==this?this._super():this._currentMenu.handleEnter()},handleESC:function(){console.log("ShopMenu.handleESC: "+(this instanceof bo)+" "+(this._currentMenu==this)),this._currentMenu==this?this._super():this._currentMenu.handleESC()}}),bh=0,bi=1,bj=2,bl=0,bm=1,bn=2,bp=Class.extend({_init:function(){this._shopDisplayed=!1,this._quantity=1,this._maxquantity=99,this._price=0,this._quantityDisplayed=!1,this._toDisplayQuantity=!1},shopDisplayed:function(){return this._menu&&this._menu.isDisplayed()},getItemList:function(){return this._itemList},displayShop:function(a,b){this._itemList=a,this._toDisplayQuantity=b,this._menu=new bo(this),this._menu.display()},displayQuantityDialog:function(a){this._quantity=1;var b;this._menu.getCurrentMenu().getType()==bi?(b=a.cost,this._maxQuantity=99):this._menu.getCurrentMenu().getType()==bj&&(b=a.sellPrice,this._maxQuantity=a.amt),this._price=b,cm(bW,100,250,300,50,10,3),bY.font="bold 16px monospace",bY.fillStyle="white",bY.textBaseline="top",console.log("Shop.displayQuantityDialog: this._quantity: "+this._quantity+" price: "+b+" item.cost "+a.cost),bY.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*b+"G",120,266),this._item=a,this._quantityDisplayed=!0},clearQuantityDialog:function(){bW.clearRect(100,250,300,50),bY.clearRect(100,250,300,50),this._quantityDisplayed=!1},increaseQuantity:function(){this._quantity<this._maxQuantity&&this._quantity++,bY.clearRect(100,250,300,50),bY.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*this._price+"G",120,266)},decreaseQuantity:function(){this._quantity>1&&this._quantity--,bY.clearRect(100,250,300,50),bY.fillText("Quantity: "+this._quantity+"  Cost: "+this._quantity*this._price+"G",120,266)},handleKey:function(a){if(this._quantityDisplayed)switch(a){case cp:case cr:this.increaseQuantity();break;case cq:case co:this.decreaseQuantity()}else this._menu.isDisplayed()&&this._menu.handleKey(a)},handleEnter:function(){if(this._quantityDisplayed){var a=this._menu.getCurrentMenu().getType();this._menu.handleESC(),a==bi?this.buyItems():a==bj&&this.sellItems()}else this._menu.isDisplayed()&&this._menu.handleEnter()},handleESC:function(){this._quantityDisplayed?this.clearQuantityDialog():this._menu.isDisplayed()&&this._menu.handleESC()},handlePurchase:function(a){this._toDisplayQuantity?this.displayQuantityDialog(a):this.buyItem(a)},handleSale:function(a){this._toDisplayQuantity?this.displayQuantityDialog(a):this.sellItem(a)},buyItem:function(a){var b=b$.getGold();b>=a.cost?(b$.spendGold(a.cost),b$.addToInventory(a.id,1),cb.displayText("You purchased 1 "+a.name+" for "+a.cost+"G."),this._menu.clearGold(),this._menu.displayGold()):cb.displayText("You do not have enough gold\nto buy a "+a.name+".\nYou only have "+b+"G.")},buyItems:function(){this.clearQuantityDialog();var a=this._item,b=b$.getGold(),c=a.cost*this._quantity;b>=c?(b$.spendGold(c),b$.addToInventory(a.id,this._quantity),cb.displayText("You purchased "+this._quantity+" "+a.name+"s for "+c+"G."),this._menu.clearGold(),this._menu.displayGold()):cb.displayText("You do not have enough gold\nto buy "+this._quantity+" "+a.name+"s.\nYou only have "+b+"G.")},sellItem:function(a){b$.removeFromInventory(a.id),b$.earnGold(a.sellPrice),this._menu.clearGold(),this._menu.displayGold(),cb.displayText("You sold 1 "+a.name+" for "+a.sellPrice+"G.")},sellItems:function(){this.clearQuantityDialog();var a=this._item,b=a.sellPrice*this._quantity;b$.removeFromInventory(a.id,this._quantity),b$.earnGold(b),this._menu.clearGold(),this._menu.displayGold(),cb.displayText("You sold "+this._quantity+" "+a.name+"s for "+b+"G.")}}),bq=Class.extend({_init:function(a){this._titlescreenImgRef=a,this._flags={},this._loadFunctions=[]},isFlagSet:function(a){return!!this._flags[a]},setFlag:function(a){this._flags[a]=!0},addLoadFunction:function(a){this._loadFunctions.push(a)},save:function(a){amplify.store("save"+a,{version:bB,timestamp:(new Date).toString(),player:b$.createSaveData(),worldmap:b_.createSaveData(),game:this.createSaveData()})},load:function(a){var b=amplify.store("save"+a);if(!b)throw new br;if(b.version!=bB)throw new bs;b$.loadSaveData(b.player),b_.loadSaveData(b.worldmap),this.loadSaveData(b.game);for(var c=0;c<this._loadFunctions.length;++c)this._loadFunctions[c]()},reset:function(){this._flags={};for(var a=0;a<this._loadFunctions.length;++a)this._loadFunctions[a]();b$.reset()},showTitleScreen:function(){bS.drawImage(cC.images[this._titlescreenImgRef].img,0,0)},hasSaveInfo:function(a){return!!amplify.store("save"+a)},getSaveInfo:function(a){var b=new Date(amplify.store("save"+a).timestamp);return dateFormat(b,"ddd, mmm d h:MM TT")},createSaveData:function(){return this._flags},loadSaveData:function(a){this._flags=a}}),br=Class.extend({}),bs=Class.extend({}),bt=0,bu=1,bv=2,bw=3,bx=4,by=0,bz=1,bA=Class.extend({_init:function(){this._background=null,this._encounter=null,this._ignoringKeys=!1,this._monsterList=null,this._currentAction=bt,this._currentMenu=by,this._over=!1,this._win=!1,this._line=0,this._txt="";var a=bR.height;this._lineHeight=[a-130,a-100,a-70,a-40],this._textHeight=[a-132,a-110,a-86,a-62,a-38],this._totalExp=0,this._totalGold=0,this._selectingMonster=!1,this._monsterSelection=0,this._onMonsterSelect=null,this._selectingItem=!1,this._itemSelection=0,this._itemId=[],this._numItems=0,this._selectingSpell=!1,this._spellSelection=0,this._spellId=[],this._numSpells=0,this._writing=!1,this._delay=0},setupRandomEncounter:function(a,b){this._background=cC.images[b].img;var c=null;for(var d=0;d<dn.zones.length;++d)dn.zones[d].zone==a&&(c=dn.zones[d]);if(c!=null){var e=c.encounters.length,f=Math.floor(Math.random()*e);this._encounter=c.encounters[f],this._monsterList=[];for(var g=0;g<this._encounter.monsters.length;++g){var h=this._encounter.monsters[g];for(var i=0;i<dp.monsters.length;++i)if(dp.monsters[i].id==h){var j=new p(dp.monsters[i]);this._monsterList.push(j)}}}cw&&(this._ignoringKeys=!0)},setupEncounter:function(a,b,c){this._background=cC.images[c].img,this._encounter={name:a,monsters:b},this._monsterList=[];for(var d=0;d<b.length;++d){var e=b[d];for(var f=0;f<dp.monsters.length;++f)if(dp.monsters[f].id==e){var g=new p(dp.monsters[f]);this._monsterList.push(g)}}cw&&(this._ignoringKeys=!0)},draw:function(){var a=bR.width,b=bR.height;bS.drawImage(this._background,0,0,a,b),bU.clearRect(0,0,a,b),this.drawPlayer(),this.drawHealthBar(),this.drawManaBar(),this.drawMonsters(),cm(bW,0,b-150,140,150,15,3),cm(bW,133,b-150,a-133,150,15,3),this._currentMenu=by,this.drawMenu(),this._currentAction=bt,this.drawArrow(),bY.font="bold 16px sans-serif";var c=this._encounter.name+" appeared!";bY.fillText(c,154,this._textHeight[0]),this._line=1,this._txt=c},drawPlayer:function(){bU.drawImage(b$._img,bK,m*bL,bK,bL,bT.width-3*bC,2*bD,bK,bL)},clearPlayer:function(){bU.clearRect(bT.width-3*bC,2*bD,bK,bL)},drawMonsters:function(){var a=2*bC;for(var b=0;b<this._monsterList.length;++b){var c=this._monsterList[b],d=cC.images[c.getImageRef()].img;bU.drawImage(d,c.getLeft(),c.getTop(),c.getWidth(),c.getHeight(),a,3*bD,c.getWidth(),c.getHeight()),c.setLoc(a),a+=c.getWidth()+15}},clearMonster:function(a){var b=this._monsterList[a];bU.clearRect(b.getLoc(),3*bD,b.getWidth(),b.getHeight())},drawHealthBar:function(){var a=bT.width-2*bC+.5,b=2*bD+.5,c=10,d=bL,e=b$.getHP()/b$.getMaxHP();e<0&&(e=0);var f=b+Math.round((1-e)*d),g=d-(f-b);bU.fillStyle="red",bU.fillRect(a,f,c,g),bU.strokeStyle="black",bU.strokeRect(a,b,c,d)},drawManaBar:function(){var a=bT.width-2*bC+10.5,b=2*bD+.5,c=10,d=bL,e=b$.getMP()/b$.getMaxMP();e<0&&(e=0);var f=b+Math.round((1-e)*d),g=d-(f-b);bU.fillStyle="#ccccff",bU.fillRect(a,f,c,g),bU.strokeStyle="black",bU.strokeRect(a,b,c,d)},clearHealthBar:function(){var a=bT.width-2*bC+.5,b=2*bD+.5,c=10,d=bL;bU.clearRect(a,b,c,d)},clearManaBar:function(){var a=bT.width-2*bC+10.5,b=2*bD+.5,c=10,d=bL;bU.clearRect(a,b,c,d)},updateHealthBar:function(a){this.clearHealthBar();var b=bT.width-2*bC+.5,c=2*bD+.5,d=10,e=bL,f=a/b$.getMaxHP();f<0&&(f=0);var g=c+Math.round((1-f)*e),h=e-(g-c);bU.fillStyle="red",bU.fillRect(b,g,d,h),bU.strokeStyle="black",bU.strokeRect(b,c,d,e)},drawMenu:function(){bY.font="bold 20px monospace",bY.fillStyle="white",bY.textBaseline="top",this._currentMenu==by?(bY.fillText("Attack",36,this._lineHeight[0]),bY.fillText("Defend",36,this._lineHeight[1]),bY.fillText("Spell",36,this._lineHeight[2]),bY.fillText("Item",36,this._lineHeight[3])):bY.fillText("Run",36,this._lineHeight[0])},clearMenu:function(){bY.clearRect(36,this._lineHeight[0],114,bX.height-this._lineHeight[0])},writeMsg:function(a){this._writing=!0;var b=this._arrow;this.clearArrow(),this._arrow=b,window.setTimeout(function(){ce.drawText();var b=ce._line<=4?ce._line:4;bY.fillText(a,154,ce._textHeight[b]),ce._txt+="\n"+a,ce._line++,ce._delay-=bP,ce._delay==0&&(ce._writing=!1,ce._arrow&&ce.drawArrow())},this._delay),this._delay+=bP},drawText:function(){bY.font="bold 16px sans-serif",bY.fillStyle="white",bY.textBaseline="top",this.clearText();var a=this._txt.split("\n");if(this._line<=4)for(var b=0;b<this._line;++b)bY.fillText(a[b],154,this._textHeight[b]);else for(var b=0;b<4;++b){var c=a[a.length-4+b];bY.fillText(c,154,this._textHeight[b])}},clearText:function(){bY.clearRect(154,this._textHeight[0],bX.width-154,bX.height-this._textHeight[0])},end:function(){bW.clearRect(0,0,bV.width,bV.height),bU.clearRect(0,0,bT.width,bT.height),bY.clearRect(0,0,bX.width,bX.height),b$.isDead()?(ca=!0,bZ.showTitleScreen()):(b_.redraw(),b_.drawSprites(),b$.plot(),this._win&&this.onWin(),this.onExit()),ce=null},drawArrow:function(){var a=this._lineHeight[this._currentAction%4],b=cC.images.pointer.img;bY.drawImage(b,16,a+2),this._arrow=!0},clearArrow:function(){var a=this._lineHeight[this._currentAction%4];bY.clearRect(15,a+2,18,11),this._arrow=!1},drawMonsterSelection:function(){var a=this._monsterList[this._monsterSelection],b=a.getLoc(),c=cC.images.pointer.img;bY.drawImage(c,b-10,3*bD)},clearMonsterSelection:function(){var a=this._monsterList[this._monsterSelection],b=a.getLoc();bY.clearRect(b-11,3*bD,18,11)},displayItems:function(){bY.font="bold 16px sans-serif",bY.fillStyle="white",bY.textBaseline="top";var a=0,b=this;b$.forEachItemInInventory(function(c,d){if(d>0){var e=dm.items[c];if(e.usable){var f=e.name,g=d<10?" "+d:d;a<=5&&bY.fillText(f+":"+g,180,b._textHeight[a]),b._itemId[a]=c,a++}}}),this._numItems=a},drawItemSelection:function(){var a=this._textHeight[this._itemSelection],b=cC.images.pointer.img;bY.drawImage(b,154,a+2)},clearItemSelection:function(){var a=this._textHeight[this._itemSelection];bY.clearRect(153,a+2,18,11)},displaySpells:function(){bY.font="bold 16px sans-serif",bY.fillStyle="white",bY.textBaseline="top";var a=0,b=this;b$.forEachSpell(function(c){var d=du.spells[c].name;a<=5&&bY.fillText(d,174,b._textHeight[a]),b._spellId[a]=c,a++}),this._numSpells=a},drawSpellSelection:function(){var a=this._textHeight[this._spellSelection],b=cC.images.pointer.img;bY.drawImage(b,154,a+2)},clearSpellSelection:function(){var a=this._textHeight[this._spellSelection];bY.clearRect(153,a+2,18,11)},handleInput:function(a){if(!this._writing&&!this._ignoringKeys)if(this._selectingMonster){this.clearMonsterSelection();switch(a){case cr:case co:do this._monsterSelection++,this._monsterSelection>=this._monsterList.length&&(this._monsterSelection=0);while(this._monsterList[this._monsterSelection].isDead());break;case cq:case cp:do this._monsterSelection--,this._monsterSelection<0&&(this._monsterSelection=this._monsterList.length-1);while(this._monsterList[this._monsterSelection].isDead())}this.drawMonsterSelection()}else if(this._selectingItem){this.clearItemSelection();switch(a){case cr:case co:this._itemSelection++,this._itemSelection>=this._numItems&&(this._itemSelection=0);break;case cq:case cp:this._itemSelection--,this._itemSelection<0&&(this._itemSelection=this._numItems-1)}this.drawItemSelection()}else if(this._selectingSpell){this.clearSpellSelection();switch(a){case cr:case co:this._spellSelection++,this._spellSelection>=this._numSpells&&(this._spellSelection=0);break;case cq:case cp:this._spellSelection--,this._spellSelection<0&&(this._spellSelection=this._numSpells-1)}this.drawSpellSelection()}else if(!this._over&&!b$.isDead()){this.clearArrow();switch(a){case co:this._currentMenu==by&&(this._currentAction=(this._currentAction+1)%4);break;case cp:this._currentMenu==by&&(this._currentAction--,this._currentAction<0&&(this._currentAction+=4));break;case cq:case cr:this._currentMenu=(this._currentMenu+1)%2,this.clearMenu(),this.drawMenu(),this._currentMenu==bz?this._currentAction=bx:this._currentAction=bt}this.drawArrow()}},handleEnter:function(){if(!this._writing)if(this._selectingMonster)this.clearMonsterSelection(),this._selectingMonster=!1,this._onMonsterSelect(this._monsterSelection);else if(!b$.isDead())if(this._over)this.end();else{var a=!1,b=!0;if(this._selectingItem){this.clearItemSelection(),this._selectingItem=!1;var c=this.useItem();c||(b=!1,this.drawText())}else if(this._selectingSpell){this.clearSpellSelection(),this._selectingSpell=!1;var c=this.useSpell();c||(b=!1,this.drawText())}else switch(this._currentAction){case bt:if(this._monsterList.length==1)this.attack(0);else{this._selectingMonster=!0,this.selectFirstLiveMonster();var d=this;this._onMonsterSelect=function(a){d.attack(a),d.finishTurn()},b=!1,this.drawMonsterSelection()}break;case bu:this.writeMsg("You defended."),a=!0;break;case bv:this._selectingSpell=!0,this.clearText(),this.displaySpells(),this.drawSpellSelection(),b=!1;break;case bw:this._selectingItem=!0,this.clearText(),this.displayItems(),this.drawItemSelection(),b=!1;break;case bx:this.run(),b=!1}!this._over&&b&&this.monsterTurn(a),this.runAfterWriting(function(){ce.clearHealthBar(),ce.clearManaBar(),ce.drawHealthBar(),ce.drawManaBar()})}},handleEsc:function(){this._selectingMonster?(this.clearMonsterSelection(),this._selectingMonster=!1):this._selectingItem?(this.clearItemSelection(),this._selectingItem=!1,this.drawText()):this._selectingSpell?(this.clearSpellSelection(),this._selectingSpell=!1,this.drawText()):this._over&&this.end()},handleKeyUp:function(){this._ignoringKeys=!1},selectFirstLiveMonster:function(){for(var a=0;a<this._monsterList.length;++a)if(!this._monsterList[a].isDead()){this._monsterSelection=a;break}},finishTurn:function(){this._over||this.monsterTurn(!1),this.runAfterWriting(function(){ce.clearHealthBar(),ce.clearManaBar(),ce.drawHealthBar(),ce.drawManaBar()})},runAfterWriting:function(a){this._writing?window.setTimeout(function(){ce.runAfterWriting(a)}):a()},forEachMonster:function(a){for(var b=0;b<this._monsterList.length;++b)this._monsterList[b].isDead()||a(this._monsterList[b],b)},earnReward:function(a,b){var c=this;window.setTimeout(function(){c.clearMonster(b)},this._delay),this.writeMsg("The "+a.getName()+" was killed."),this._totalExp+=a.getExp(),this._totalGold+=a.getGold();for(var d=0;d<this._monsterList.length;++d)if(!this._monsterList[d].isDead())return;b$.earnGold(this._totalGold);var e=b$.earnExp(this._totalExp);this.writeMsg("You have earned "+this._totalExp+" exp"),this.writeMsg("and "+this._totalGold+" GP."),e&&this.writeMsg("You gained a level!"),this._over=!0,this._win=!0,this.clearArrow()},attack:function(a){var b=this._monsterList[a],c=Math.random();if(c>.95)this.writeMsg("You missed!");else{var d=b$.getAttack()-b.getDefense();c>.9&&(this.writeMsg("Critical Hit!"),d*=2),d<1&&(d=1),d-=Math.floor(Math.random()*d/2),this.writeMsg("You attacked for "+d+" damage."),b.damage(d),b.isDead()&&this.earnReward(b,a)}},monsterTurn:function(a){for(var b=0;b<this._monsterList.length;++b){var c=this._monsterList[b];if(!c.isDead()){if(c.hasSpecialAttack()&&Math.random()<.5)c.useSpecialAttack();else{var d=Math.random();if(d>.9)this.writeMsg("The "+c.getName()+" missed!");else{var e=c.getAttack()-b$.getDefense();d>.86&&(this.writeMsg("Terrible Hit!"),e=2*c.getAttack()-b$.getDefense()),a&&(e=Math.floor(e/2.5)),e<1&&(e=1),e-=Math.floor(Math.random()*e/2),b$.damage(e),this.writeMsg("The "+c.getName()+" attacked for"),this.writeMsg(e+" damage.");var f=this,g=b$.getHP();window.setTimeout(function(a){return function(){f.updateHealthBar(a)}}(g),this._delay)}}if(b$.isDead()){this.writeMsg("You died."),this._over=!0,this.clearArrow();var f=this;this.runAfterWriting(function(){f.clearPlayer()});return}}}},run:function(){if(Math.random()>=.33){this.writeMsg("You start to run."),this.monsterTurn(!1);if(b$.isDead()||this._over)return!1;if(Math.random()<.33){this.writeMsg("You couldn't run away.");return!1}}this.writeMsg("You ran away."),this._over=!0,this.clearArrow();var a=this;this.runAfterWriting(function(){a.clearPlayer()});return!0},useItem:function(){if(this._itemSelection<this._numItems){var a=this._itemId[this._itemSelection],b=dm.items[a];switch(b.type){case cJ:b.use(b$);break;case cK:b.use()}b$.removeFromInventory(a);return!0}return!1},useSpell:function(){if(this._spellSelection<this._numSpells){var a=this._spellId[this._spellSelection],b=du.spells[a];if(b$.getMP()>=b.mpCost){switch(b.type){case dq:b.use(b$);break;case dr:b.use()}b$.useMP(b.mpCost);return!0}this.writeMsg("You do not have enough MP"),this.writeMsg("to cast "+b.name+".")}return!1},onExit:function(){},onWin:function(){}}),bB="0.1pre 20110514",bC=32,bD=32,bE=13,bF=11,bG=5,bH=7,bI=4,bJ=6,bK=32,bL=48,bM=25,bN=4,bO=.14,bP=500,bQ=1e4,bR=document.getElementById("mapCanvas"),bS=bR.getContext("2d"),bT=document.getElementById("spriteCanvas"),bU=bT.getContext("2d"),bV=document.getElementById("menuCanvas"),bW=bV.getContext("2d"),bX=document.getElementById("textCanvas"),bY=bX.getContext("2d"),bZ=null,b$=null,b_=null,ca=!0,cb=new r,cc=new bc,cd=new bp,ce=null,cf=!1,cg=new b,ch=[bR,bT,bV,bX,document.getElementById("gamepad")];Object.keys||(Object.keys=function(a){var b=[];for(k in a)a.hasOwnProperty(k)&&b.push(k);return b}),$(document).ready(function(){cg.onComplete=function(){document.getElementById("loaded").innerHTML="Loading Complete!"},cg.onFail=function(){var a="One or more resource(s) was not loaded:<br>",b=cg.getList();for(var c=0;c<b.length;++c)a+=b[c]+"<br>";document.getElementById("loaded").innerHTML=a},bZ=new bq("titlescreen"),cj(),ck()});var co=40,cp=38,cq=37,cr=39,cs=32,ct=13,cu=27,cv=0,cw=!1;window.opera||$.browser.mozilla?$(window).keypress(cx):$(window).keydown(cx),$(window).keyup(cy),$(document).ready(function(){var a=document.getElementById("showpad");a.onclick=function(){if(a.innerHTML=="Show Gamepad"){var b=document.getElementById("gamepad");b.style.display="block",a.innerHTML="Hide Gamepad";var c=document.getElementById("nokeyb");c.style.display="none"}else{var b=document.getElementById("gamepad");b.style.display="none",a.innerHTML="Show Gamepad";var c=document.getElementById("nokeyb");c.style.display="inline"}};var b=document.getElementById("upButton");b.onclick=function(a){cz(cp,a)};var c=document.getElementById("downButton");c.onclick=function(a){cz(co,a)};var d=document.getElementById("leftButton");d.onclick=function(a){cz(cq,a)};var e=document.getElementById("rightButton");e.onclick=function(a){cz(cr,a)};var f=document.getElementById("escButton");f.onclick=function(a){cz(cu,a)};var g=document.getElementById("enterButton");g.onclick=function(a){cz(ct,a)}}),$(window).dblclick(function(a){cf=!cf,cB(),a.preventDefault()}),$(window).resize(function(){cf&&cB()});var cC={images:{titlescreen:{url:"images/titlescreen.png",load:function(){bZ.showTitleScreen()}},pointer:{url:"images/pointer.png"},world:{url:"images/World3.png"},trevor:{url:"images/Trevor.png"},meadow:{url:"images/meadow.png"},InqCastle:{url:"images/InqCastle.png"},forest:{url:"images/Dark_Forest.png"},enemies:{url:"images/enemies-t2.png"},chest:{url:"images/Chest2.png"},soldier:{url:"images/Soldier2.png"},InqIndoors:{url:"images/Inq_XP_Medieval_Indoors.png"},man1:{url:"images/Man1.png"},man2:{url:"images/Man2.png"},woman1:{url:"images/Woman1.png"},woman2:{url:"images/Woman2.png"},boy:{url:"images/Boy.png"}}},cD=0,cE=1,cF=2,cG=3,cH={submaps:{0:{id:cD,tileset:{imgRef:"world",width:256,height:1152},xmlUrl:"xml/WorldMap1.tmx.xml",randomEncounters:!0,background:"meadow",overWorld:!0,load:function(){b$=new o(23,13,"trevor",0,l,dv),cn(function(){b_.goToMap(b$,0,23,13,17,8,l)})},entrances:[{fromX:23,fromY:14,toMapId:cE,toX:12,toY:18,toScrollX:6,toScrollY:9,facing:i,onEnter:function(){b$.restore()}},{fromX:13,fromY:9,toMapId:cG,toX:9,toY:28,toScrollX:3,toScrollY:19,facing:i}]},1:{id:cE,tileset:{imgRef:"InqCastle",width:256,height:2304},xmlUrl:"xml/Castle1.tmx.xml",randomEncounters:!1,overWorld:!1,entrances:[{fromX:11,fromY:12,toMapId:cF,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:i},{fromX:12,fromY:12,toMapId:cF,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:i},{fromX:13,fromY:12,toMapId:cF,toX:10,toY:18,toScrollX:4,toScrollY:9,facing:i}],exit:{at:"edges",toMapId:cD,toX:23,toY:14,toScrollX:17,toScrollY:9,facing:l},npcs:[{imgRef:"soldier",locX:10,locY:14,facing:l,displayText:"You may enter the castle now.",walks:!1},{imgRef:"soldier",locX:14,locY:14,facing:l,displayText:"But the interior is still under\nconstruction.",walks:!1}]},2:{id:cF,tileset:{imgRef:"InqIndoors",width:256,height:8704},xmlUrl:"xml/CastleShops.tmx.xml",randomEncounters:!1,overWorld:!1,exit:{at:"bottom",toMapId:cE,toX:12,toY:12,toScrollX:6,toScrollY:7,facing:l},npcs:[{imgRef:"man1",locX:1,locY:8,facing:j,displayText:"Welcome to the weapon shop.",callback:function(){cd.displayShop([cT,cU,cV,cW],!1)},walks:!1},{imgRef:"man2",locX:18,locY:8,facing:m,displayText:"Welcome to the armor shop.",callback:function(){cd.displayShop([c$,c_,da,dd,de,df,di,dj,dk],!1)},walks:!1},{imgRef:"woman2",locX:1,locY:12,facing:j,displayText:"Welcome to the item shop.",callback:function(){cd.displayShop([cP,cQ,cR],!0)},walks:!1},{imgRef:"woman1",locX:10,locY:12,facing:l,displayText:"Welcome to the castle's tavern.",walks:!0},{imgRef:"boy",locX:16,locY:17,facing:m,displayText:"Whenever I return to the castle,\nI feel completely refreshed and\nrestored.",walks:!0}],actions:[{locX:3,locY:8,dir:m,onAction:function(){cH.submaps[cF].npcs[0].npc.action()}},{locX:16,locY:8,dir:j,onAction:function(){cH.submaps[cF].npcs[1].npc.action()}},{locX:3,locY:12,dir:m,onAction:function(){cH.submaps[cF].npcs[2].npc.action()}}]},3:{id:cG,tileset:{imgRef:"forest",width:256,height:576},xmlUrl:"xml/Forest1.tmx.xml",randomEncounters:!0,zone:"forest",background:"meadow",overWorld:!1,load:function(){var a=cG,b=b_.getSubMap(a),c=new g(11,7,32,58,"enemies",a,664,249);c.action=function(){cb.setCallback(function(){cv=0,ce=new bA,ce.setupEncounter("A rat king",[10],"meadow"),ce.onWin=function(){bZ.setFlag("fb"),c.clear(),b.removeSprite(c)},ce.draw()}),cb.displayText("I am the rat king.\nI rule this domain.\nPrepare to die.")},b.addSprite(c),bZ.addLoadFunction(function(){bZ.isFlagSet("fb")?(c.clear(),b.removeSprite(c)):b.hasSprite(c)||b.addSprite(c)})},exit:{at:"bottom",toMapId:cD,toX:13,toY:9,toScrollX:7,toScrollY:4,facing:l},chests:[{imgRef:"chest",locX:3,locY:27,event:"fc1",action:function(){this.onOpenFindItem("You found 5 potions.",cP,5)}},{imgRef:"chest",locX:17,locY:11,event:"fc2",action:function(){this.onOpenFindItem("You found 3 bombs.",cQ,3)}},{imgRef:"chest",locX:16,locY:2,event:"fc3",action:function(){this.onOpenLearnSpell(ds)}},{imgRef:"chest",locX:3,locY:7,event:"fc4",action:function(){this.onOpenLearnSpell(dt)}}]}}},cI=.75,cJ=1,cK=4,cL=5,cM=6,cN=7,cO=8,cP=0,cQ=1,cR=2,cS=10,cT=11,cU=12,cV=13,cW=14,cX=15,cY=16,cZ=20,c$=21,c_=22,da=23,db=24,dc=30,dd=31,de=32,df=33,dg=34,dh=40,di=41,dj=42,dk=43,dl=44,dm={items:{0:{id:cP,name:"Potion",type:cJ,cost:15,usable:!0,use:function(
a){var b=100+Math.floor(Math.random()*100);a.heal(b),cl(a.getName()+" healed for "+b+" points.")}},1:{id:cQ,name:"Bomb",type:cK,cost:35,usable:!0,use:function(){ce.forEachMonster(function(a,b){var c=50+Math.floor(Math.random()*100);c-=a.getDefense(),c<1&&(c=1),a.damage(c),ce.writeMsg("The "+a.getName()+" was hit for "),ce.writeMsg(c+" damage."),a.isDead()&&ce.earnReward(a,b)})}},2:{id:cR,name:"Ether",type:cJ,cost:100,usable:!0,use:function(a){var b=25+Math.floor(Math.random()*25);a.gainMP(b),cl(a.getName()+" healed for "+b+" magic points.")}},10:{id:cS,name:"Tin Sword",type:cL,cost:10,usable:!1,attack:5},11:{id:cT,name:"Copper Sword",type:cL,cost:30,usable:!1,attack:10},12:{id:cU,name:"Bronze Sword",type:cL,cost:90,usable:!1,attack:15},13:{id:cV,name:"Iron Sword",type:cL,cost:270,usable:!1,attack:20},14:{id:cW,name:"Steel Sword",type:cL,cost:810,usable:!1,attack:25},15:{id:cX,name:"Broad Sword",type:cL,cost:2430,usable:!1,attack:30},16:{id:cY,name:"Great Sword",type:cL,cost:7290,usable:!1,attack:35},20:{id:cZ,name:"Clothes",type:cM,cost:10,usable:!1,defense:1},21:{id:c$,name:"Leather Armor",type:cM,cost:50,usable:!1,defense:4},22:{id:c_,name:"Chain Mail",type:cM,cost:250,usable:!1,defense:7},23:{id:da,name:"Half Plate Mail",type:cM,cost:1250,usable:!1,defense:10},24:{id:db,name:"Full Plate Mail",type:cM,cost:6250,usable:!1,defense:13},30:{id:dc,name:"Cap",type:cN,cost:5,usable:!1,defense:1},31:{id:dd,name:"Leather Helmet",type:cN,cost:30,usable:!1,defense:2},32:{id:de,name:"Bronze Helmet",type:cN,cost:150,usable:!1,defense:4},33:{id:df,name:"Iron Helmet",type:cN,cost:600,usable:!1,defense:6},34:{id:dg,name:"Steel Helmet",type:cN,cost:1800,usable:!1,defense:8},40:{id:dh,name:"Tin Shield",type:cO,cost:35,usable:!1,defense:1},41:{id:di,name:"Copper Shield",type:cO,cost:90,usable:!1,defense:2},42:{id:dj,name:"Bronze Shield",type:cO,cost:230,usable:!1,defense:4},43:{id:dk,name:"Iron Shield",type:cO,cost:700,usable:!1,defense:6},44:{id:dl,name:"Steel Shield",type:cO,cost:2100,usable:!1,defense:8}}},dn={zones:[{zone:"1",encounters:[{name:"A slime",monsters:[0]},{name:"A rat",monsters:[1]},{name:"A snake",monsters:[2]},{name:"2 slimes",monsters:[0,0]},{name:"3 slimes",monsters:[0,0,0]},{name:"A rat and a slime",monsters:[1,0]}]},{zone:"2",encounters:[{name:"3 snakes",monsters:[2,2,2]},{name:"3 blue slimes",monsters:[3,3,3]},{name:"A red slime",monsters:[5]},{name:"2 red slimes",monsters:[5,5]},{name:"A cocatrice",monsters:[4]},{name:"A white rat",monsters:[6]}]},{zone:"3",encounters:[{name:"2 red slimes",monsters:[5,5]},{name:"3 red slimes",monsters:[5,5,5]},{name:"A cocatrice",monsters:[4]},{name:"A white rat",monsters:[6]},{name:"A cobra",monsters:[7]},{name:"A wolf",monsters:[8]}]},{zone:"4",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"5",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"6",encounters:[{name:"2 cobras",monsters:[7,7]},{name:"2 wolves",monsters:[8,8]},{name:"3 cocatrices",monsters:[4,4,4]},{name:"3 white rats",monsters:[6,6,6]},{name:"A wolf and a cobra",monsters:[8,7]},{name:"A mage",monsters:[9]}]},{zone:"forest",encounters:[{name:"3 rats",monsters:[1,1,1]},{name:"A blue slime",monsters:[3]},{name:"2 blue slimes",monsters:[3,3]},{name:"A snake",monsters:[2]},{name:"A snake and a rat",monsters:[2,1]},{name:"A cocatrice",monsters:[4]}]}]},dp={monsters:[{id:0,name:"slime",hp:15,attack:10,defense:0,exp:5,gold:5,imgRef:"enemies",left:4,top:109,width:31,height:24},{id:1,name:"rat",hp:25,attack:15,defense:2,exp:10,gold:5,imgRef:"enemies",left:7,top:498,width:63,height:55},{id:2,name:"snake",hp:30,attack:20,defense:6,exp:15,gold:10,imgRef:"enemies",left:7,top:160,width:48,height:59},{id:3,name:"blue slime",hp:20,attack:20,defense:20,exp:20,gold:10,imgRef:"enemies",left:78,top:109,width:31,height:24},{id:4,name:"cocatrice",hp:45,attack:32,defense:16,exp:30,gold:30,imgRef:"enemies",left:14,top:329,width:47,height:67},{id:5,name:"red slime",hp:30,attack:30,defense:30,exp:30,gold:15,imgRef:"enemies",left:41,top:109,width:31,height:24},{id:6,name:"white rat",hp:55,attack:38,defense:20,exp:40,gold:30,imgRef:"enemies",left:145,top:498,width:63,height:55},{id:7,name:"cobra",hp:60,attack:42,defense:30,exp:40,gold:40,imgRef:"enemies",left:67,top:160,width:48,height:59},{id:8,name:"wolf",hp:68,attack:46,defense:28,exp:50,gold:25,imgRef:"enemies",left:7,top:685,width:47,height:55},{id:9,name:"mage",hp:100,attack:55,defense:20,exp:60,gold:40,imgRef:"enemies",left:640,top:153,width:32,height:33,special:function(a){var b=-1,c=9999;ce.writeMsg("The "+a.getName()+" casts Heal."),ce.forEachMonster(function(a,d){!a.isDead()&&a.getHP()<c&&(c=a.getHP(),b=d)});var d=ce._monsterList[b],e=50+Math.floor(Math.random()*50);d.heal(e),ce.writeMsg("The "+d.getName()+" was healed for "+e+".")}},{id:10,name:"rat king",hp:200,attack:55,defense:35,exp:120,gold:80,imgRef:"enemies",left:653,top:249,width:47,height:58}]},dq=1,dr=4,ds=0,dt=1,du={spells:[{id:ds,name:"Heal",mpCost:5,type:dq,use:function(a){var b=100+Math.floor(Math.random()*100);a.heal(b),cl(a.getName()+" healed for "+b+" points.")}},{id:dt,name:"Bomb",mpCost:8,type:dr,use:function(){ce.forEachMonster(function(a,b){var c=50+Math.floor(Math.random()*100);c-=a.getDefense(),c<1&&(c=1),a.damage(c),ce.writeMsg("The "+a.getName()+" was hit for "),ce.writeMsg(c+" damage."),a.isDead()&&ce.earnReward(a,b)})}}]},dv=0,dw={players:[{id:0,name:"You",level:1,maxHP:100,maxMP:5,attack:12,defense:0,exp:0,gold:0,weapon:cS,armor:cZ,helmet:dc,shield:dh,inventory:[],spells:[],levels:[0,50,110,200,350,600,1e3,1500,2250,3375,5e3,7500,11250,16875,25e3,37500,56250,84375,126500,189750,284625,426900,640350,960525,1440750,2161125,3241650,4862475,7293700,10940550,16410825],max_levels:30,maxHP_increase:20,maxMP_increase:5,attack_increase:2,defense_increase:1}]}